<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>和风天气测试工具</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .test-section { margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px; }
    button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
    .result { margin-top: 10px; padding: 15px; background: white; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
    .success { border-left: 4px solid green; }
    .error { border-left: 4px solid red; }
    input { padding: 8px; width: 300px; margin: 5px 0; }
    label { display: block; margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>和风天气 API 测试工具</h1>

  <div class="test-section">
    <h3>1. API Key 测试</h3>
    <label>API Key</label>
    <input type="text" id="apiKey" placeholder="输入 API Key" />
    <label>城市</label>
    <input type="text" id="city1" value="北京" />
    <button onclick="testAPIKey()">测试 API Key</button>
    <div id="apiKeyResult" class="result"></div>
  </div>

  <div class="test-section">
    <h3>2. JWT Token 生成与验证</h3>
    <p>点击下方按钮生成 JWT token，然后将其复制到和风天气控制台的 <a href="https://console.qweather.com/#/apps/jwt" target="_blank">JWT 验证页面</a> 进行验证。</p>
    <button onclick="generateAndTestJWT()">生成并测试 JWT</button>
    <div id="jwtResult" class="result"></div>
  </div>

  <div class="test-section">
    <h3>3. 当前配置</h3>
    <button onclick="loadConfig()">加载当前配置</button>
    <div id="configResult" class="result"></div>
  </div>

  <script type="module">
    async function testAPIKey() {
      const apiKey = document.getElementById('apiKey').value;
      const city = document.getElementById('city1').value;
      const resultDiv = document.getElementById('apiKeyResult');

      if (!apiKey) {
        resultDiv.className = 'result error';
        resultDiv.textContent = '请输入 API Key';
        return;
      }

      try {
        const response = await fetch(`https://kt487t53tq.re.qweatherapi.com/v7/weather/now?location=${encodeURIComponent(city)}`, {
          headers: { 'X-QW-Api-Key': apiKey }
        });

        const result = await response.json();

        resultDiv.className = response.ok && result.code === '200' ? 'result success' : 'result error';
        resultDiv.textContent = `Status: ${response.status}\n\n${JSON.stringify(result, null, 2)}`;
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.textContent = `Error: ${error.message}`;
      }
    }

    async function generateAndTestJWT() {
      const resultDiv = document.getElementById('jwtResult');
      resultDiv.textContent = '正在生成 JWT...';

      try {
        // 从 storage 读取配置
        const result = await chrome.storage.local.get(['qweatherKeyId', 'qweatherProjectId', 'qweatherPrivateKey']);
        const { qweatherKeyId, qweatherProjectId, qweatherPrivateKey } = result;

        if (!qweatherKeyId || !qweatherProjectId || !qweatherPrivateKey) {
          resultDiv.className = 'result error';
          resultDiv.textContent = '请先在扩展设置中配置 JWT 凭据';
          return;
        }

        // 向 background 请求生成 JWT
        const response = await chrome.runtime.sendMessage({ action: 'GET_WEATHER' });

        if (!response || !response.success) {
          throw new Error(response?.error || '获取 JWT 失败');
        }

        const token = response.token;
        const jwtToken = token.replace('Bearer ', '');

        // 解析 JWT
        const parts = jwtToken.split('.');
        const header = JSON.parse(atob(parts[0]));
        const payload = JSON.parse(atob(parts[1]));

        resultDiv.className = 'result';
        resultDiv.innerHTML = `<strong>JWT Header:</strong>
${JSON.stringify(header, null, 2)}

<strong>JWT Payload:</strong>
${JSON.stringify(payload, null, 2)}

<strong>完整 JWT Token:</strong>
${jwtToken}

<strong>Bearer Token:</strong>
${token}

请将上面的"完整 JWT Token"复制到和风天气控制台的 JWT 验证页面进行验证。`;

        // 测试 API
        const apiResponse = await fetch(`https://kt487t53tq.re.qweatherapi.com/v7/weather/now?location=101010100`, {
          headers: { Authorization: token }
        });

        const apiResult = await apiResponse.json();

        const testDiv = document.createElement('div');
        testDiv.className = apiResponse.ok && apiResult.code === '200' ? 'result success' : 'result error';
        testDiv.textContent = `\n\nAPI 测试结果:\nStatus: ${apiResponse.status}\n\n${JSON.stringify(apiResult, null, 2)}`;
        resultDiv.appendChild(testDiv);

      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.textContent = `错误: ${error.message}`;
      }
    }

    async function loadConfig() {
      const resultDiv = document.getElementById('configResult');

      try {
        const result = await chrome.storage.local.get(['qweatherKeyId', 'qweatherProjectId', 'qweatherPrivateKey', 'weather']);

        resultDiv.className = 'result';
        resultDiv.innerHTML = `<strong>凭据ID:</strong> ${result.qweatherKeyId || '(未设置)'}
<strong>项目ID:</strong> ${result.qweatherProjectId || '(未设置)'}
<strong>私钥:</strong> ${result.qweatherPrivateKey ? '(已设置 ' + result.qweatherPrivateKey.length + ' 字符)' : '(未设置)'}
<strong>天气城市:</strong> ${result.weather?.city || '北京'}

请确认以上配置与和风天气控制台中的信息一致。`;
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.textContent = `错误: ${error.message}`;
      }
    }

    // 暴露给 window
    window.testAPIKey = testAPIKey;
    window.generateAndTestJWT = generateAndTestJWT;
    window.loadConfig = loadConfig;

    // 页面加载时自动加载配置
    loadConfig();
  </script>
</body>
</html>
